name: Test Data Pipeline

on:
    workflow_dispatch:

jobs:
    test-data:
        runs-on: ubuntu-latest
        permissions:
            contents: read
        env:
            REPO_NAME: ${GITHUB_REPOSITORY/-/\ } # placeholder, reset in script
        steps:
            - name: Checkout
              uses: actions/checkout@v6.0.1

            - name: Derive repo name
              id: repo
              run: |
                  set -euo pipefail
                  raw_repo="${GITHUB_REPOSITORY}"
                  repo_name_fs=$(echo "$raw_repo" | tr '/' '-')
                  echo "repo_name=$raw_repo" >> "$GITHUB_OUTPUT"
                  echo "repo_name_fs=$repo_name_fs" >> "$GITHUB_OUTPUT"

            - name: Create dummy results and artifact
              env:
                  REPO_NAME: ${{ steps.repo.outputs.repo_name_fs }}
              run: |
                  set -euo pipefail
                  mkdir -p artifact/${REPO_NAME}/data artifact/${REPO_NAME}/dockerfiles

                  cat > results.json <<'EOF'
                  {
                    "baseline": {"status": "success", "size": 500000000, "time": 200, "omega": 5, "errors": 0, "warnings": 1, "penalty": 0.05, "cost": 1.05},
                    "human":    {"status": "success", "size": 420000000, "time": 300, "omega": 8, "errors": 1, "warnings": 2, "penalty": 0.20, "cost": 1.70},
                    "dockai":   {"status": "success", "size": 360000000, "time": 240, "omega": 3, "errors": 0, "warnings": 1, "penalty": 0.05, "cost": 0.85},
                    "notes":    {"winner": "DockAI"}
                  }
                  EOF

                  echo "FROM scratch" > artifact/${REPO_NAME}/dockerfiles/Dockerfile.human
                  echo "FROM scratch" > artifact/${REPO_NAME}/dockerfiles/Dockerfile.dockai
                  cp results.json artifact/${REPO_NAME}/data/
                  echo "Dummy report" > artifact/${REPO_NAME}/report.md

            - name: Publish Metrics to Google Sheet (optional)
              if: always()
              env:
                  SHEET_ID: ${{ secrets.GDRIVE_SHEET_ID }}
                  SA_KEY: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_KEY }}
                  REPO_NAME: ${{ steps.repo.outputs.repo_name }}
                  BRANCH_NAME: main
              run: |
                  set -euo pipefail

                  if [ -z "${SHEET_ID:-}" ]; then
                    echo "SHEET_ID not set; skipping sheet update" >&2
                    exit 0
                  fi

                  echo "$SA_KEY" > /tmp/sa.json
                  python -m pip install --quiet gspread google-auth

                  cat <<'PY' > /tmp/update_sheet.py
                  import datetime
                  import json
                  import os
                  import sys

                  import gspread
                  from gspread.utils import rowcol_to_a1
                  from google.oauth2.service_account import Credentials

                  sheet_id = os.environ.get("SHEET_ID")
                  sheet_tab = os.environ.get("SHEET_TAB")
                  repo_name = os.environ.get("REPO_NAME", "unknown")
                  branch_name = os.environ.get("BRANCH_NAME", "unknown")

                  try:
                      with open("results.json", "r", encoding="utf-8") as f:
                          data = json.load(f)
                  except FileNotFoundError:
                      print("results.json not found; skipping sheet update", file=sys.stderr)
                      sys.exit(0)

                  def get(obj, *keys, default=""):
                      cur = obj
                      for k in keys:
                          if not isinstance(cur, dict) or k not in cur:
                              return default
                          cur = cur[k]
                      return cur

                  def to_mb(val):
                      try:
                          return round(float(val) / 1024 / 1024, 2)
                      except Exception:
                          return ""

                  def format_sheet(ws, headers):
                      # Apply simple readability formatting; best-effort so errors are non-fatal
                      try:
                          last_col_a1 = rowcol_to_a1(1, len(headers))
                          last_col_letter = last_col_a1.rstrip("1")
                          header_range = f"A1:{last_col_letter}1"
                          data_range = f"A2:{last_col_letter}{ws.row_count}"

                          ws.freeze(rows=1)
                          ws.set_basic_filter(f"A1:{last_col_letter}{ws.row_count}")

                          ws.format("A:A", {"numberFormat": {"type": "DATE_TIME", "pattern": "yyyy-mm-dd hh:mm:ss"}})

                          numeric_formats = [
                              ("F:F", "0.00"), ("N:N", "0.00"), ("V:V", "0.00"),
                              ("G:G", "0"),   ("O:O", "0"),   ("W:W", "0"),
                              ("H:H", "0"),   ("P:P", "0"),   ("X:X", "0"),
                              ("I:J", "0"),   ("Q:R", "0"),   ("Y:Z", "0"),
                              ("K:K", "0.00"), ("S:S", "0.00"), ("AA:AA", "0.00"),
                              ("L:L", "0.00"), ("T:T", "0.00"), ("AB:AB", "0.00"),
                          ]

                          for col_range, pattern in numeric_formats:
                              ws.format(col_range, {"numberFormat": {"type": "NUMBER", "pattern": pattern}})

                          ws.spreadsheet.batch_update({
                              "requests": [
                                  {
                                      "repeatCell": {
                                          "range": {
                                              "sheetId": ws.id,
                                              "startRowIndex": 0,
                                              "endRowIndex": 1,
                                              "startColumnIndex": 0,
                                              "endColumnIndex": len(headers),
                                          },
                                          "cell": {
                                              "userEnteredFormat": {
                                                  "textFormat": {"bold": True},
                                                  "backgroundColor": {"red": 0.95, "green": 0.95, "blue": 0.95},
                                                  "padding": {"top": 2, "bottom": 2, "left": 6, "right": 6},
                                              }
                                          },
                                          "fields": "userEnteredFormat(textFormat,backgroundColor,padding)",
                                      }
                                  },
                                  {
                                      "repeatCell": {
                                          "range": {
                                              "sheetId": ws.id,
                                              "startRowIndex": 1,
                                              "endRowIndex": ws.row_count,
                                              "startColumnIndex": 0,
                                              "endColumnIndex": len(headers),
                                          },
                                          "cell": {
                                              "userEnteredFormat": {
                                                  "textFormat": {"bold": False},
                                                  "padding": {"top": 2, "bottom": 2, "left": 4, "right": 4},
                                              }
                                          },
                                          "fields": "userEnteredFormat(textFormat,padding)",
                                      }
                                  },
                                  {
                                      "addConditionalFormatRule": {
                                          "rule": {
                                              "ranges": [{
                                                  "sheetId": ws.id,
                                                  "startRowIndex": 1,
                                                  "endRowIndex": ws.row_count,
                                                  "startColumnIndex": 3,
                                                  "endColumnIndex": 4,
                                              }],
                                              "booleanRule": {
                                                  "condition": {
                                                      "type": "TEXT_EQ",
                                                      "values": [{"userEnteredValue": "DockAI"}],
                                                  },
                                                  "format": {
                                                      "backgroundColor": {"red": 0.90, "green": 0.97, "blue": 0.91},
                                                      "textFormat": {"bold": True},
                                                  },
                                              },
                                          },
                                      },
                                  },
                                  {
                                      "autoResizeDimensions": {
                                          "dimensions": {
                                              "sheetId": ws.id,
                                              "dimension": "COLUMNS",
                                              "startIndex": 0,
                                              "endIndex": len(headers),
                                          }
                                      }
                                  }
                              ]
                          })
                      except Exception as exc:
                          print(f"Formatting skipped: {exc}", file=sys.stderr)

                  now = datetime.datetime.utcnow().isoformat() + "Z"
                  winner = get(data, "notes", "winner")

                  base = get(data, "baseline", default={})
                  human = get(data, "human", default={})
                  dockai = get(data, "dockai", default={})

                  def row_for(obj):
                      return [
                          get(obj, "status"),
                          to_mb(get(obj, "size")),
                          get(obj, "time"),
                          get(obj, "omega"),
                          get(obj, "errors"),
                          get(obj, "warnings"),
                          get(obj, "penalty"),
                          get(obj, "cost"),
                      ]

                  rows = [[
                      now,
                      repo_name,
                      branch_name,
                      winner,
                      *row_for(base),
                      *row_for(human),
                      *row_for(dockai),
                  ]]

                  headers = [
                      "timestamp_utc",
                      "repo",
                      "branch",
                      "winner",
                      "baseline_status",
                      "baseline_size_mb",
                      "baseline_time_s",
                      "baseline_omega",
                      "baseline_errors",
                      "baseline_warnings",
                      "baseline_penalty",
                      "baseline_cost",
                      "human_status",
                      "human_size_mb",
                      "human_time_s",
                      "human_omega",
                      "human_errors",
                      "human_warnings",
                      "human_penalty",
                      "human_cost",
                      "dockai_status",
                      "dockai_size_mb",
                      "dockai_time_s",
                      "dockai_omega",
                      "dockai_errors",
                      "dockai_warnings",
                      "dockai_penalty",
                      "dockai_cost",
                  ]

                  scopes = [
                      "https://www.googleapis.com/auth/spreadsheets",
                      "https://www.googleapis.com/auth/drive.file",
                  ]
                  creds = Credentials.from_service_account_file("/tmp/sa.json", scopes=scopes)
                  client = gspread.authorize(creds)
                  sheet = client.open_by_key(sheet_id)
                  ws = sheet.worksheet(sheet_tab) if sheet_tab else sheet.sheet1

                  try:
                      first_row = ws.row_values(1)
                  except Exception:
                      first_row = []
                  if not any(first_row):
                      ws.insert_row(headers, 1)

                  ws.append_rows(rows, value_input_option="USER_ENTERED")
                  format_sheet(ws, headers)
                  PY

                  python /tmp/update_sheet.py

            - name: Upload GitHub Artifact
              uses: actions/upload-artifact@v5.0.0
              with:
                  name: test-research-data-${{ steps.repo.outputs.repo_name_fs }}
                  path: artifact/${{ steps.repo.outputs.repo_name_fs }}
