name: DocKAI Microservices Test

on:
    push:
        branches: [main]
        paths:
            - "repos.json"
            - ".github/workflows/dockai-test.yml"
    pull_request:
        branches: [main]
    workflow_dispatch:

permissions:
    contents: read

jobs:
    test-dockai:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Clone microservices-demo repository
              run: |
                  echo "üîÑ Cloning GoogleCloudPlatform/microservices-demo..."
                  git clone --depth 1 https://github.com/GoogleCloudPlatform/microservices-demo target-repo
                  echo "‚úÖ Successfully cloned repository"

            - name: Display repository structure
              run: |
                  echo "üìÇ Microservices in src/:"
                  ls -la target-repo/src/

            - name: Test adservice (Java)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: adservice (Java)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/adservice"

                  # Remove existing Dockerfile
                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for adservice
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/adservice

            - name: Verify adservice Dockerfile
              run: |
                  if [ -f "target-repo/src/adservice/Dockerfile" ]; then
                    echo "‚úÖ Dockerfile generated for adservice!"
                    echo "üìÑ Content:"
                    cat target-repo/src/adservice/Dockerfile
                  else
                    echo "‚ùå Failed to generate Dockerfile for adservice"
                    exit 1
                  fi

            - name: Test cartservice (C#)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: cartservice (C#)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/cartservice"

                  # Remove existing Dockerfile
                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for cartservice
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/cartservice

            - name: Verify cartservice Dockerfile
              run: |
                  if [ -f "target-repo/src/cartservice/Dockerfile" ]; then
                    echo "‚úÖ Dockerfile generated for cartservice!"
                    echo "üìÑ Content:"
                    cat target-repo/src/cartservice/Dockerfile
                  else
                    echo "‚ùå Failed to generate Dockerfile for cartservice"
                    exit 1
                  fi

            - name: Test checkoutservice (Go)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: checkoutservice (Go)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/checkoutservice"

                  # Remove existing Dockerfile
                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for checkoutservice
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/checkoutservice

            - name: Verify checkoutservice Dockerfile
              run: |
                  if [ -f "target-repo/src/checkoutservice/Dockerfile" ]; then
                    echo "‚úÖ Dockerfile generated for checkoutservice!"
                    echo "üìÑ Content:"
                    cat target-repo/src/checkoutservice/Dockerfile
                  else
                    echo "‚ùå Failed to generate Dockerfile for checkoutservice"
                    exit 1
                  fi

            - name: Test currencyservice (Node.js)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: currencyservice (Node.js)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/currencyservice"

                  # Remove existing Dockerfile
                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for currencyservice
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/currencyservice

            - name: Verify currencyservice Dockerfile
              run: |
                  if [ -f "target-repo/src/currencyservice/Dockerfile" ]; then
                    echo "‚úÖ Dockerfile generated for currencyservice!"
                    echo "üìÑ Content:"
                    cat target-repo/src/currencyservice/Dockerfile
                  else
                    echo "‚ùå Failed to generate Dockerfile for currencyservice"
                    exit 1
                  fi

            - name: Test emailservice (Python)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: emailservice (Python)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/emailservice"

                  # Remove existing Dockerfile
                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for emailservice
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/emailservice

            - name: Verify emailservice Dockerfile
              run: |
                  if [ -f "target-repo/src/emailservice/Dockerfile" ]; then
                    echo "‚úÖ Dockerfile generated for emailservice!"
                    echo "üìÑ Content:"
                    cat target-repo/src/emailservice/Dockerfile
                  else
                    echo "‚ùå Failed to generate Dockerfile for emailservice"
                    exit 1
                  fi

            - name: Test frontend (Go)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: frontend (Go)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/frontend"

                  # Remove existing Dockerfile
                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for frontend
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/frontend

            - name: Verify frontend Dockerfile
              run: |
                  if [ -f "target-repo/src/frontend/Dockerfile" ]; then
                    echo "‚úÖ Dockerfile generated for frontend!"
                    echo "üìÑ Content:"
                    cat target-repo/src/frontend/Dockerfile
                  else
                    echo "‚ùå Failed to generate Dockerfile for frontend"
                    exit 1
                  fi

            - name: Test loadgenerator (Python)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: loadgenerator (Python)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/loadgenerator"

                  # Remove existing Dockerfile
                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for loadgenerator
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/loadgenerator

            - name: Verify loadgenerator Dockerfile
              run: |
                  if [ -f "target-repo/src/loadgenerator/Dockerfile" ]; then
                    echo "‚úÖ Dockerfile generated for loadgenerator!"
                    echo "üìÑ Content:"
                    cat target-repo/src/loadgenerator/Dockerfile
                  else
                    echo "‚ùå Failed to generate Dockerfile for loadgenerator"
                    exit 1
                  fi

            - name: Test paymentservice (Node.js)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: paymentservice (Node.js)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/paymentservice"

                  # Remove existing Dockerfile
                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for paymentservice
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/paymentservice

            - name: Verify paymentservice Dockerfile
              run: |
                  if [ -f "target-repo/src/paymentservice/Dockerfile" ]; then
                    echo "‚úÖ Dockerfile generated for paymentservice!"
                    echo "üìÑ Content:"
                    cat target-repo/src/paymentservice/Dockerfile
                  else
                    echo "‚ùå Failed to generate Dockerfile for paymentservice"
                    exit 1
                  fi

            - name: Test productcatalogservice (Go)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: productcatalogservice (Go)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/productcatalogservice"

                  # Remove existing Dockerfile
                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for productcatalogservice
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/productcatalogservice

            - name: Verify productcatalogservice Dockerfile
              run: |
                  if [ -f "target-repo/src/productcatalogservice/Dockerfile" ]; then
                    echo "‚úÖ Dockerfile generated for productcatalogservice!"
                    echo "üìÑ Content:"
                    cat target-repo/src/productcatalogservice/Dockerfile
                  else
                    echo "‚ùå Failed to generate Dockerfile for productcatalogservice"
                    exit 1
                  fi

            - name: Test recommendationservice (Python)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: recommendationservice (Python)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/recommendationservice"

                  # Remove existing Dockerfile
                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for recommendationservice
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/recommendationservice

            - name: Verify recommendationservice Dockerfile
              run: |
                  if [ -f "target-repo/src/recommendationservice/Dockerfile" ]; then
                    echo "‚úÖ Dockerfile generated for recommendationservice!"
                    echo "üìÑ Content:"
                    cat target-repo/src/recommendationservice/Dockerfile
                  else
                    echo "‚ùå Failed to generate Dockerfile for recommendationservice"
                    exit 1
                  fi

            - name: Test shippingservice (Go)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: shippingservice (Go)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/shippingservice"

                  # Remove existing Dockerfile
                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for shippingservice
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/shippingservice

            - name: Verify shippingservice Dockerfile
              run: |
                  if [ -f "target-repo/src/shippingservice/Dockerfile" ]; then
                    echo "‚úÖ Dockerfile generated for shippingservice!"
                    echo "üìÑ Content:"
                    cat target-repo/src/shippingservice/Dockerfile
                  else
                    echo "‚ùå Failed to generate Dockerfile for shippingservice"
                    exit 1
                  fi

            - name: Test shoppingassistantservice (Python)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: shoppingassistantservice (Python)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/shoppingassistantservice"

                  # Remove existing Dockerfile
                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for shoppingassistantservice
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/shoppingassistantservice

            - name: Verify shoppingassistantservice Dockerfile
              run: |
                  if [ -f "target-repo/src/shoppingassistantservice/Dockerfile" ]; then
                    echo "‚úÖ Dockerfile generated for shoppingassistantservice!"
                    echo "üìÑ Content:"
                    cat target-repo/src/shoppingassistantservice/Dockerfile
                  else
                    echo "‚ùå Failed to generate Dockerfile for shoppingassistantservice"
                    exit 1
                  fi

            - name: Test Summary
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üìä DocKAI Test Suite Summary"
                  echo "=============================================="
                  echo ""
                  echo "‚úÖ All 12 microservices tested successfully!"
                  echo ""
                  echo "Services tested:"
                  echo "  1. adservice (Java)"
                  echo "  2. cartservice (C#)"
                  echo "  3. checkoutservice (Go)"
                  echo "  4. currencyservice (Node.js)"
                  echo "  5. emailservice (Python)"
                  echo "  6. frontend (Go)"
                  echo "  7. loadgenerator (Python)"
                  echo "  8. paymentservice (Node.js)"
                  echo "  9. productcatalogservice (Go)"
                  echo "  10. recommendationservice (Python)"
                  echo "  11. shippingservice (Go)"
                  echo "  12. shoppingassistantservice (Python)"
                  echo ""
                  echo "Test completed at: $(date)"
