name: DocKAI Microservices Test

on:
    push:
        branches: [main]
        paths:
            - "repos.json"
            - ".github/workflows/dockai-test.yml"
    pull_request:
        branches: [main]
    workflow_dispatch:

permissions:
    contents: read

env:
    RESULTS_FILE: test-results.txt

jobs:
    test-dockai:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Clone microservices-demo repository
              run: |
                  echo "üîÑ Cloning GoogleCloudPlatform/microservices-demo..."
                  git clone --depth 1 https://github.com/GoogleCloudPlatform/microservices-demo target-repo
                  echo "‚úÖ Successfully cloned repository"

                  # Initialize results file
                  echo "# DocKAI Test Results" > $RESULTS_FILE
                  echo "Date: $(date)" >> $RESULTS_FILE
                  echo "" >> $RESULTS_FILE

            - name: Display repository structure
              run: |
                  echo "üìÇ Microservices in src/:"
                  ls -la target-repo/src/

            # ==================== adservice (Java) ====================
            - name: Prepare adservice (Java)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: adservice (Java)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/adservice"

                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for adservice
              id: dockai-adservice
              continue-on-error: true
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/adservice
                  max_retries: "0"

            - name: Verify adservice Dockerfile
              run: |
                  if [ -f "target-repo/src/adservice/Dockerfile" ]; then
                    echo "‚úÖ adservice: SUCCESS" >> $RESULTS_FILE
                    echo "‚úÖ Dockerfile generated for adservice!"
                    cat target-repo/src/adservice/Dockerfile
                  else
                    echo "‚ùå adservice: FAILED" >> $RESULTS_FILE
                    echo "‚ùå Failed to generate Dockerfile for adservice"
                  fi

            # ==================== cartservice (C#) ====================
            - name: Prepare cartservice (C#)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: cartservice (C#)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/cartservice"

                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for cartservice
              id: dockai-cartservice
              continue-on-error: true
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/cartservice
                  max_retries: "0"

            - name: Verify cartservice Dockerfile
              run: |
                  if [ -f "target-repo/src/cartservice/Dockerfile" ]; then
                    echo "‚úÖ cartservice: SUCCESS" >> $RESULTS_FILE
                    echo "‚úÖ Dockerfile generated for cartservice!"
                    cat target-repo/src/cartservice/Dockerfile
                  else
                    echo "‚ùå cartservice: FAILED" >> $RESULTS_FILE
                    echo "‚ùå Failed to generate Dockerfile for cartservice"
                  fi

            # ==================== checkoutservice (Go) ====================
            - name: Prepare checkoutservice (Go)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: checkoutservice (Go)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/checkoutservice"

                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for checkoutservice
              id: dockai-checkoutservice
              continue-on-error: true
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/checkoutservice
                  max_retries: "0"

            - name: Verify checkoutservice Dockerfile
              run: |
                  if [ -f "target-repo/src/checkoutservice/Dockerfile" ]; then
                    echo "‚úÖ checkoutservice: SUCCESS" >> $RESULTS_FILE
                    echo "‚úÖ Dockerfile generated for checkoutservice!"
                    cat target-repo/src/checkoutservice/Dockerfile
                  else
                    echo "‚ùå checkoutservice: FAILED" >> $RESULTS_FILE
                    echo "‚ùå Failed to generate Dockerfile for checkoutservice"
                  fi

            # ==================== currencyservice (Node.js) ====================
            - name: Prepare currencyservice (Node.js)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: currencyservice (Node.js)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/currencyservice"

                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for currencyservice
              id: dockai-currencyservice
              continue-on-error: true
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/currencyservice
                  max_retries: "0"

            - name: Verify currencyservice Dockerfile
              run: |
                  if [ -f "target-repo/src/currencyservice/Dockerfile" ]; then
                    echo "‚úÖ currencyservice: SUCCESS" >> $RESULTS_FILE
                    echo "‚úÖ Dockerfile generated for currencyservice!"
                    cat target-repo/src/currencyservice/Dockerfile
                  else
                    echo "‚ùå currencyservice: FAILED" >> $RESULTS_FILE
                    echo "‚ùå Failed to generate Dockerfile for currencyservice"
                  fi

            # ==================== emailservice (Python) ====================
            - name: Prepare emailservice (Python)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: emailservice (Python)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/emailservice"

                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for emailservice
              id: dockai-emailservice
              continue-on-error: true
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/emailservice
                  max_retries: "0"

            - name: Verify emailservice Dockerfile
              run: |
                  if [ -f "target-repo/src/emailservice/Dockerfile" ]; then
                    echo "‚úÖ emailservice: SUCCESS" >> $RESULTS_FILE
                    echo "‚úÖ Dockerfile generated for emailservice!"
                    cat target-repo/src/emailservice/Dockerfile
                  else
                    echo "‚ùå emailservice: FAILED" >> $RESULTS_FILE
                    echo "‚ùå Failed to generate Dockerfile for emailservice"
                  fi

            # ==================== frontend (Go) ====================
            - name: Prepare frontend (Go)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: frontend (Go)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/frontend"

                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for frontend
              id: dockai-frontend
              continue-on-error: true
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/frontend
                  max_retries: "0"

            - name: Verify frontend Dockerfile
              run: |
                  if [ -f "target-repo/src/frontend/Dockerfile" ]; then
                    echo "‚úÖ frontend: SUCCESS" >> $RESULTS_FILE
                    echo "‚úÖ Dockerfile generated for frontend!"
                    cat target-repo/src/frontend/Dockerfile
                  else
                    echo "‚ùå frontend: FAILED" >> $RESULTS_FILE
                    echo "‚ùå Failed to generate Dockerfile for frontend"
                  fi

            # ==================== loadgenerator (Python) ====================
            - name: Prepare loadgenerator (Python)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: loadgenerator (Python)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/loadgenerator"

                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for loadgenerator
              id: dockai-loadgenerator
              continue-on-error: true
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/loadgenerator
                  max_retries: "0"

            - name: Verify loadgenerator Dockerfile
              run: |
                  if [ -f "target-repo/src/loadgenerator/Dockerfile" ]; then
                    echo "‚úÖ loadgenerator: SUCCESS" >> $RESULTS_FILE
                    echo "‚úÖ Dockerfile generated for loadgenerator!"
                    cat target-repo/src/loadgenerator/Dockerfile
                  else
                    echo "‚ùå loadgenerator: FAILED" >> $RESULTS_FILE
                    echo "‚ùå Failed to generate Dockerfile for loadgenerator"
                  fi

            # ==================== paymentservice (Node.js) ====================
            - name: Prepare paymentservice (Node.js)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: paymentservice (Node.js)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/paymentservice"

                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for paymentservice
              id: dockai-paymentservice
              continue-on-error: true
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/paymentservice
                  max_retries: "0"

            - name: Verify paymentservice Dockerfile
              run: |
                  if [ -f "target-repo/src/paymentservice/Dockerfile" ]; then
                    echo "‚úÖ paymentservice: SUCCESS" >> $RESULTS_FILE
                    echo "‚úÖ Dockerfile generated for paymentservice!"
                    cat target-repo/src/paymentservice/Dockerfile
                  else
                    echo "‚ùå paymentservice: FAILED" >> $RESULTS_FILE
                    echo "‚ùå Failed to generate Dockerfile for paymentservice"
                  fi

            # ==================== productcatalogservice (Go) ====================
            - name: Prepare productcatalogservice (Go)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: productcatalogservice (Go)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/productcatalogservice"

                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for productcatalogservice
              id: dockai-productcatalogservice
              continue-on-error: true
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/productcatalogservice
                  max_retries: "0"

            - name: Verify productcatalogservice Dockerfile
              run: |
                  if [ -f "target-repo/src/productcatalogservice/Dockerfile" ]; then
                    echo "‚úÖ productcatalogservice: SUCCESS" >> $RESULTS_FILE
                    echo "‚úÖ Dockerfile generated for productcatalogservice!"
                    cat target-repo/src/productcatalogservice/Dockerfile
                  else
                    echo "‚ùå productcatalogservice: FAILED" >> $RESULTS_FILE
                    echo "‚ùå Failed to generate Dockerfile for productcatalogservice"
                  fi

            # ==================== recommendationservice (Python) ====================
            - name: Prepare recommendationservice (Python)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: recommendationservice (Python)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/recommendationservice"

                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for recommendationservice
              id: dockai-recommendationservice
              continue-on-error: true
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/recommendationservice
                  max_retries: "0"

            - name: Verify recommendationservice Dockerfile
              run: |
                  if [ -f "target-repo/src/recommendationservice/Dockerfile" ]; then
                    echo "‚úÖ recommendationservice: SUCCESS" >> $RESULTS_FILE
                    echo "‚úÖ Dockerfile generated for recommendationservice!"
                    cat target-repo/src/recommendationservice/Dockerfile
                  else
                    echo "‚ùå recommendationservice: FAILED" >> $RESULTS_FILE
                    echo "‚ùå Failed to generate Dockerfile for recommendationservice"
                  fi

            # ==================== shippingservice (Go) ====================
            - name: Prepare shippingservice (Go)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: shippingservice (Go)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/shippingservice"

                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for shippingservice
              id: dockai-shippingservice
              continue-on-error: true
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/shippingservice
                  max_retries: "0"

            - name: Verify shippingservice Dockerfile
              run: |
                  if [ -f "target-repo/src/shippingservice/Dockerfile" ]; then
                    echo "‚úÖ shippingservice: SUCCESS" >> $RESULTS_FILE
                    echo "‚úÖ Dockerfile generated for shippingservice!"
                    cat target-repo/src/shippingservice/Dockerfile
                  else
                    echo "‚ùå shippingservice: FAILED" >> $RESULTS_FILE
                    echo "‚ùå Failed to generate Dockerfile for shippingservice"
                  fi

            # ==================== shoppingassistantservice (Python) ====================
            - name: Prepare shoppingassistantservice (Python)
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üß™ Testing: shoppingassistantservice (Python)"
                  echo "=============================================="

                  SERVICE_PATH="target-repo/src/shoppingassistantservice"

                  if [ -f "$SERVICE_PATH/Dockerfile" ]; then
                    echo "üóëÔ∏è Removing existing Dockerfile..."
                    rm -f "$SERVICE_PATH/Dockerfile"
                    rm -f "$SERVICE_PATH/.dockerignore"
                  fi

                  echo "üìÇ Service contents:"
                  ls -la $SERVICE_PATH/

            - name: Generate Dockerfile for shoppingassistantservice
              id: dockai-shoppingassistantservice
              continue-on-error: true
              uses: itzzjb/dockai@v3.0.0
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo/src/shoppingassistantservice
                  max_retries: "0"

            - name: Verify shoppingassistantservice Dockerfile
              run: |
                  if [ -f "target-repo/src/shoppingassistantservice/Dockerfile" ]; then
                    echo "‚úÖ shoppingassistantservice: SUCCESS" >> $RESULTS_FILE
                    echo "‚úÖ Dockerfile generated for shoppingassistantservice!"
                    cat target-repo/src/shoppingassistantservice/Dockerfile
                  else
                    echo "‚ùå shoppingassistantservice: FAILED" >> $RESULTS_FILE
                    echo "‚ùå Failed to generate Dockerfile for shoppingassistantservice"
                  fi

            # ==================== Final Summary ====================
            - name: Test Summary
              run: |
                  echo ""
                  echo "=============================================="
                  echo "üìä DocKAI Test Suite Summary"
                  echo "=============================================="
                  echo ""

                  cat $RESULTS_FILE

                  echo ""
                  echo "=============================================="

                  # Count successes and failures
                  SUCCESS_COUNT=$(grep -c "SUCCESS" $RESULTS_FILE || echo "0")
                  FAIL_COUNT=$(grep -c "FAILED" $RESULTS_FILE || echo "0")

                  echo ""
                  echo "üìà Results: $SUCCESS_COUNT passed, $FAIL_COUNT failed out of 12 microservices"
                  echo ""

                  if [ "$FAIL_COUNT" -gt 0 ]; then
                    echo "‚ö†Ô∏è Some tests failed. Check the logs above for details."
                  else
                    echo "üéâ All tests passed!"
                  fi

                  echo ""
                  echo "Test completed at: $(date)"

            - name: Upload test results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: dockai-test-results
                  path: |
                      ${{ env.RESULTS_FILE }}
                      target-repo/src/*/Dockerfile
                  retention-days: 30
