name: Test DockAI Action

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:

jobs:
    test-dockai:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout test repository
              uses: actions/checkout@v4

            - name: Read config.json
              id: read-config
              run: |
                  REPO_URL=$(jq -r '.repository_url' config.json)
                  # Extract owner/repo from full URL if needed
                  REPO_PATH=$(echo "$REPO_URL" | sed 's|https://github.com/||' | sed 's|\.git$||')
                  echo "repo_url=$REPO_PATH" >> $GITHUB_OUTPUT
                  echo "Target repository: $REPO_PATH"

            - name: Checkout target repository
              uses: actions/checkout@v4
              with:
                  repository: ${{ steps.read-config.outputs.repo_url }}
                  path: target-repo

            - name: Create .dockai config for target repo
              run: |
                  cat > target-repo/.dockai << 'EOF'
                  [instructions_generator]
                  CRITICAL REQUIREMENTS:
                  1. Use python:3.7-slim as base image (Pipfile.lock requires Python 3.7)
                  2. Install system build packages BEFORE running pip or pipenv:
                     - build-essential
                     - gcc
                     - python3-dev
                     - libffi-dev
                     - libssl-dev
                     - libpq-dev
                  3. Use multi-stage build: builder stage for compilation, runtime for just the app
                  4. In runtime stage, install only runtime libraries (libpq5, libssl, libffi)
                  5. Use pip to install from requirements.txt
                  6. Run container as non-root user
                  7. Use gunicorn as WSGI server from Procfile
                  8. Bind to 0.0.0.0:$PORT for proper port handling
                  EOF

            - name: Run DockAI to generate Dockerfile
              uses: itzzjb/dockai@v3
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo
                  max_retries: 7
            - name: Check if Dockerfile was generated
              run: |
                  if [ -f target-repo/Dockerfile ]; then
                    echo "âœ… Dockerfile successfully generated!"
                    echo "Contents:"
                    cat target-repo/Dockerfile
                  else
                    echo "âŒ Dockerfile was not generated"
                    exit 1
                  fi

            - name: Upload generated Dockerfile
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: generated-dockerfile
                  path: target-repo/Dockerfile
                  retention-days: 30
