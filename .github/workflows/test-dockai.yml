name: Test DockAI Action

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:

jobs:
    test-dockai:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout test repository
              uses: actions/checkout@v4

            - name: Read config.json
              id: read-config
              run: |
                  REPO_URL=$(jq -r '.repository_url' config.json)
                  # Extract owner/repo from full URL if needed
                  REPO_PATH=$(echo "$REPO_URL" | sed 's|https://github.com/||' | sed 's|\.git$||')
                  echo "repo_url=$REPO_PATH" >> $GITHUB_OUTPUT
                  echo "Target repository: $REPO_PATH"

            - name: Checkout target repository
              uses: actions/checkout@v4
              with:
                  repository: ${{ steps.read-config.outputs.repo_url }}
                  path: target-repo

            - name: Create .dockai config for target repo
              run: |
                  cat > target-repo/.dockai << 'EOF'
                  [instructions_generator]
                  This Flask application uses Pipenv for dependency management.
                  CRITICAL: Install the following system packages in the BUILDER stage before running pipenv install:
                  - gcc
                  - python3-dev
                  - libffi-dev
                  - libssl-dev
                  - build-essential

                  In the RUNTIME stage:
                  - Copy the installed Python packages from the builder stage
                  - Install runtime system dependencies: libffi-dev libssl-dev
                  - Use pip to install from requirements.txt (generated from Pipfile.lock)
                  - Run as non-root user
                  - Use gunicorn as specified in Procfile
                  EOF

            - name: Run DockAI to generate Dockerfile
              uses: itzzjb/dockai@v3
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: target-repo
                  max_retries: 7
                  model_analyzer: gpt-5-mini
                  model_blueprint: gpt-5-mini
                  model_generator: gpt-5-mini
                  model_generator_iterative: gpt-5-mini
                  model_reviewer: gpt-5-mini
                  model_reflector: gpt-5-mini
                  model_error_analyzer: gpt-5-mini
                  model_iterative_improver: gpt-5-mini

            - name: Check if Dockerfile was generated
              run: |
                  if [ -f target-repo/Dockerfile ]; then
                    echo "âœ… Dockerfile successfully generated!"
                    echo "Contents:"
                    cat target-repo/Dockerfile
                  else
                    echo "âŒ Dockerfile was not generated"
                    exit 1
                  fi

            - name: Upload generated Dockerfile
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: generated-dockerfile
                  path: target-repo/Dockerfile
                  retention-days: 30
