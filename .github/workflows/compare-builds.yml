name: Compare DockAI vs Human vs CNB

on:
    workflow_dispatch:
        inputs:
            repo_url:
                description: "Target repository (owner/repo or full https URL)"
                required: false
                default: ""
            branch:
                description: "Branch or ref to check out"
                required: false
                default: "main"

jobs:
    compare:
        name: Build and Benchmark Images
        runs-on: ubuntu-latest
        env:
            TARGET_DIR: target-repo
            REPORT_PATH: report.md
            HUMAN_IMG: human-candidate:latest
            DOCKAI_IMG: dockai-candidate:latest
            CNB_IMG: cnb-candidate:latest
            PACK_VERSION: v0.34.2
        steps:
            - name: Checkout workflow repo
              uses: actions/checkout@v4

            - name: Resolve target repo
              id: repo
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  set -euo pipefail
                  input_repo="${{ github.event.inputs.repo_url }}"
                  input_branch="${{ github.event.inputs.branch }}"
                  config_repo=$(jq -r '.repository_url // empty' config.json)

                  repo="${input_repo:-$config_repo}"
                  if [ -z "$repo" ] || [ "$repo" = "null" ]; then
                    echo "Repository not provided via input or config.json" >&2
                    exit 1
                  fi

                  # Normalize to https URL for cloning
                  case "$repo" in
                    http*) clone_url="$repo" ;;
                    git@*) clone_url="$repo" ;;
                    *) clone_url="https://github.com/${repo}" ;;
                  esac

                  # Use a tokenized URL for private repos, but mask it to avoid leakage
                  auth_clone_url="$clone_url"
                  if [ -n "${GITHUB_TOKEN:-}" ] && [[ "$clone_url" =~ ^https://github.com/ ]]; then
                    echo "::add-mask::${GITHUB_TOKEN}"
                    auth_clone_url="https://${GITHUB_ACTOR:-github-actions}:${GITHUB_TOKEN}@github.com/${repo}"
                  fi

                  default_branch=$(git ls-remote --symref "$auth_clone_url" HEAD 2>/dev/null | awk '/^ref:/ {print $2}' | sed 's@refs/heads/@@' | head -n1)
                  if [ -z "$default_branch" ]; then
                    default_branch="main"
                  fi

                  checkout_ref="$default_branch"
                  if [ -n "$input_branch" ]; then
                    if git ls-remote --heads "$auth_clone_url" "$input_branch" >/dev/null 2>&1; then
                      checkout_ref="$input_branch"
                    else
                      echo "Requested branch '$input_branch' not found; falling back to '$default_branch'" >&2
                    fi
                  fi

                  echo "clone_url=$clone_url" >> "$GITHUB_OUTPUT"
                  echo "auth_clone_url=$auth_clone_url" >> "$GITHUB_OUTPUT"
                  echo "repo_label=$repo" >> "$GITHUB_OUTPUT"
                  echo "checkout_ref=$checkout_ref" >> "$GITHUB_OUTPUT"

            - name: Checkout target repo
              env:
                  GIT_TERMINAL_PROMPT: 0
              run: |
                  set -euo pipefail
                  rm -rf "${TARGET_DIR}"
                  ref="${{ steps.repo.outputs.checkout_ref }}"
                  auth_url="${{ steps.repo.outputs.auth_clone_url }}"
                  base_url="${{ steps.repo.outputs.clone_url }}"

                  if [ -n "$ref" ]; then
                    git clone --depth=1 --branch "$ref" "$auth_url" "${TARGET_DIR}" || {
                      echo "Clone with --branch $ref failed; retrying default without --branch" >&2
                      git clone --depth=1 "$auth_url" "${TARGET_DIR}"
                    }
                  else
                    git clone --depth=1 "$auth_url" "${TARGET_DIR}"
                  fi

                  # Remove embedded credentials from the local remote URL
                  git -C "${TARGET_DIR}" remote set-url origin "$base_url"

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Install toolchain (hadolint, trivy, pack)
              run: |
                  set -euo pipefail
                  sudo apt-get update
                  sudo apt-get install -y jq curl ca-certificates

                  # hadolint
                  curl -sSL https://github.com/hadolint/hadolint/releases/download/v2.12.0/hadolint-Linux-x86_64 -o hadolint
                  sudo install -m 0755 hadolint /usr/local/bin/hadolint

                  # trivy
                  curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin

                  # pack
                  curl -sSL "https://github.com/buildpacks/pack/releases/download/${PACK_VERSION}/pack-${PACK_VERSION}-linux.tgz" | sudo tar -xz -C /usr/local/bin pack

            - name: Detect Dockerfiles
              id: detect
              run: |
                  set -euo pipefail
                  human_present=false
                  dockai_present=false

                  [ -f "${TARGET_DIR}/Dockerfile" ] && human_present=true
                  [ -f "${TARGET_DIR}/Dockerfile.dockai" ] && dockai_present=true

                  echo "human_present=$human_present" >> "$GITHUB_OUTPUT"
                  echo "dockai_present=$dockai_present" >> "$GITHUB_OUTPUT"

            - name: Build human Dockerfile
              if: steps.detect.outputs.human_present == 'true'
              run: |
                  set -euo pipefail
                  docker build --file "${TARGET_DIR}/Dockerfile" --tag ${HUMAN_IMG} "${TARGET_DIR}"

            - name: Build DockAI Dockerfile
              if: steps.detect.outputs.dockai_present == 'true'
              run: |
                  set -euo pipefail
                  docker build --file "${TARGET_DIR}/Dockerfile.dockai" --tag ${DOCKAI_IMG} "${TARGET_DIR}"

            - name: Build CNB image
              run: |
                  set -euo pipefail
                  pack build ${CNB_IMG} \
                    --builder paketobuildpacks/builder:base \
                    --path "${TARGET_DIR}" \
                    --pull-policy if-not-present

            - name: Lint human Dockerfile
              if: steps.detect.outputs.human_present == 'true'
              run: |
                  set -euo pipefail
                  hadolint "${TARGET_DIR}/Dockerfile" -f json > hadolint-human.json || true

            - name: Lint DockAI Dockerfile
              if: steps.detect.outputs.dockai_present == 'true'
              run: |
                  set -euo pipefail
                  hadolint "${TARGET_DIR}/Dockerfile.dockai" -f json > hadolint-dockai.json || true

            - name: Trivy scan human image
              if: steps.detect.outputs.human_present == 'true'
              run: |
                  set -euo pipefail
                  trivy image --quiet --format json -o trivy-human.json ${HUMAN_IMG}

            - name: Trivy scan DockAI image
              if: steps.detect.outputs.dockai_present == 'true'
              run: |
                  set -euo pipefail
                  trivy image --quiet --format json -o trivy-dockai.json ${DOCKAI_IMG}

            - name: Trivy scan CNB image
              run: |
                  set -euo pipefail
                  trivy image --quiet --format json -o trivy-cnb.json ${CNB_IMG}

            - name: Collect metrics and compare
              id: metrics
              run: |
                  set -euo pipefail
                  report=${REPORT_PATH}

                  human_from="N/A"; dockai_from="N/A"
                  [ -f "${TARGET_DIR}/Dockerfile" ] && human_from=$(grep -m1 '^FROM ' "${TARGET_DIR}/Dockerfile" | awk '{print $2}')
                  [ -f "${TARGET_DIR}/Dockerfile.dockai" ] && dockai_from=$(grep -m1 '^FROM ' "${TARGET_DIR}/Dockerfile.dockai" | awk '{print $2}')

                  get_size_layers() {
                    img=$1
                    if docker image inspect "$img" >/dev/null 2>&1; then
                      size=$(docker image inspect "$img" --format '{{.Size}}')
                      layers=$(docker history "$img" --no-trunc | tail -n +2 | wc -l)
                    else
                      size=0; layers=0
                    fi
                    echo "$size $layers"
                  }

                  read human_size human_layers < <(get_size_layers ${HUMAN_IMG})
                  read dockai_size dockai_layers < <(get_size_layers ${DOCKAI_IMG})
                  read cnb_size cnb_layers < <(get_size_layers ${CNB_IMG})

                  human_hadolint="N/A"
                  [ -f hadolint-human.json ] && human_hadolint=$(jq 'length' hadolint-human.json)
                  dockai_hadolint="N/A"
                  [ -f hadolint-dockai.json ] && dockai_hadolint=$(jq 'length' hadolint-dockai.json)

                  trivy_totals() {
                    file=$1
                    if [ -f "$file" ]; then
                      total=$(jq '[.Results[].Vulnerabilities[]?] | length' "$file")
                      critical=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$file")
                      high=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "$file")
                      medium=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' "$file")
                      low=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="LOW")] | length' "$file")
                      echo "$total $critical $high $medium $low"
                    else
                      echo "N/A N/A N/A N/A N/A"
                    fi
                  }

                  read human_trivy_total human_trivy_critical human_trivy_high human_trivy_medium human_trivy_low < <(trivy_totals trivy-human.json)
                  read dockai_trivy_total dockai_trivy_critical dockai_trivy_high dockai_trivy_medium dockai_trivy_low < <(trivy_totals trivy-dockai.json)
                  read cnb_trivy_total cnb_trivy_critical cnb_trivy_high cnb_trivy_medium cnb_trivy_low < <(trivy_totals trivy-cnb.json)

                  to_num() {
                    val=$1
                    if echo "$val" | grep -Eq '^[0-9]+$'; then
                      echo "$val"
                    else
                      echo 0
                    fi
                  }

                  score() {
                    sz_bytes=$1; layers=$2; hadocnt=$3; trivytotal=$4; trivyhigh=$5; trivycritical=$6
                    python -c $'import os\nsz=float(os.environ.get("SZ",0))\nlayers=float(os.environ.get("LAYERS",0))\nhad=float(os.environ.get("HADO",0))\ntvt=float(os.environ.get("TRIVY_T",0))\ntvh=float(os.environ.get("TRIVY_H",0))\ntvc=float(os.environ.get("TRIVY_C",0))\nscore=max(0, 100 - (sz/1024/1024)*0.08 - layers*1.2 - had*0.4 - tvt*0.18 - tvh*0.7 - tvc*1.2)\nprint(round(score, 2))'
                  }

                  human_score=$(SZ=$human_size LAYERS=$human_layers HADO=$(to_num $human_hadolint) TRIVY_T=$(to_num $human_trivy_total) TRIVY_H=$(to_num $human_trivy_high) TRIVY_C=$(to_num $human_trivy_critical) score)
                  dockai_score=$(SZ=$dockai_size LAYERS=$dockai_layers HADO=$(to_num $dockai_hadolint) TRIVY_T=$(to_num $dockai_trivy_total) TRIVY_H=$(to_num $dockai_trivy_high) TRIVY_C=$(to_num $dockai_trivy_critical) score)
                  cnb_score=$(SZ=$cnb_size LAYERS=$cnb_layers HADO=0 TRIVY_T=$(to_num $cnb_trivy_total) TRIVY_H=$(to_num $cnb_trivy_high) TRIVY_C=$(to_num $cnb_trivy_critical) score)

                  winner="DockAI"; best=$dockai_score
                  if [ "$(printf '%.2f' $human_score)" != "0.00" ] && awk "BEGIN {exit !($human_score > $best)}"; then best=$human_score; winner="Human"; fi
                  if awk "BEGIN {exit !($cnb_score > $best)}"; then best=$cnb_score; winner="CNB"; fi

                  bytes_to_mb() {
                    python -c $'import sys\nval=sys.stdin.read().strip()\ntry:\n    print(round(int(val)/(1024*1024),2))\nexcept Exception:\n    print("N/A")'
                  }

                  human_mb=$(echo "$human_size" | bytes_to_mb)
                  dockai_mb=$(echo "$dockai_size" | bytes_to_mb)
                  cnb_mb=$(echo "$cnb_size" | bytes_to_mb)

                  printf '%s\n' \
                    '# Container Build Comparison' \
                    '' \
                    '## Inputs' \
                    "- Target repository: ${{ steps.repo.outputs.repo_label }}" \
                    "- Winner (highest score): ${winner}" \
                    '' \
                    '## Dockerfile origins' \
                    "- Human Dockerfile: ${human_from}" \
                    "- DockAI Dockerfile: ${dockai_from}" \
                    '- CNB Buildpacks: paketobuildpacks/builder:base' \
                    '' \
                    '## Image Metrics' \
                    '| Image | Size (MB) | Layers | Score (higher is better) |' \
                    '| --- | --- | --- | --- |' \
                    "| Human | ${human_mb} | ${human_layers} | ${human_score} |" \
                    "| DockAI | ${dockai_mb} | ${dockai_layers} | ${dockai_score} |" \
                    "| CNB | ${cnb_mb} | ${cnb_layers} | ${cnb_score} |" \
                    '' \
                    '## Lint & Vulnerability Summary' \
                    '| Item | Hadolint Findings | Trivy Total | Critical | High | Medium | Low |' \
                    '| --- | --- | --- | --- | --- | --- | --- |' \
                    "| Human | ${human_hadolint} | ${human_trivy_total} | ${human_trivy_critical} | ${human_trivy_high} | ${human_trivy_medium} | ${human_trivy_low} |" \
                    "| DockAI | ${dockai_hadolint} | ${dockai_trivy_total} | ${dockai_trivy_critical} | ${dockai_trivy_high} | ${dockai_trivy_medium} | ${dockai_trivy_low} |" \
                    "| CNB | N/A | ${cnb_trivy_total} | ${cnb_trivy_critical} | ${cnb_trivy_high} | ${cnb_trivy_medium} | ${cnb_trivy_low} |" \
                    '' \
                    '## Notes' \
                    '- Score: 100 - 0.08*sizeMB - 1.2*layers - 0.4*hadolint - 0.18*trivy_total - 0.7*trivy_high - 1.2*trivy_critical (floored at 0).' \
                    '- Higher score rewards smaller images, fewer layers, and fewer lint/vuln findings with heavier weight on critical issues.' \
                    '- Base images extracted from the first FROM line.' \
                    > "$report"

                  {
                    echo "## Winner: ${winner}"
                    echo "| Image | Score | Size (MB) | Critical | High | Medium | Low |"
                    echo "| --- | --- | --- | --- | --- | --- | --- |"
                    echo "| Human | ${human_score} | ${human_mb} | ${human_trivy_critical} | ${human_trivy_high} | ${human_trivy_medium} | ${human_trivy_low} |"
                    echo "| DockAI | ${dockai_score} | ${dockai_mb} | ${dockai_trivy_critical} | ${dockai_trivy_high} | ${dockai_trivy_medium} | ${dockai_trivy_low} |"
                    echo "| CNB | ${cnb_score} | ${cnb_mb} | ${cnb_trivy_critical} | ${cnb_trivy_high} | ${cnb_trivy_medium} | ${cnb_trivy_low} |"
                    echo ""
                    echo "Detailed report: ${report}"
                  } >> "$GITHUB_STEP_SUMMARY"

                  echo "report_path=$report" >> "$GITHUB_OUTPUT"

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: comparison-report
                  if-no-files-found: warn
                  path: |
                      report.md
                      ${{ env.TARGET_DIR }}/Dockerfile
                      ${{ env.TARGET_DIR }}/Dockerfile.dockai
                      hadolint-human.json
                      hadolint-dockai.json
                      trivy-human.json
                      trivy-dockai.json
                      trivy-cnb.json
