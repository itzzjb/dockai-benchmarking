name: Compare DockAI vs Human vs CNB

on:
    workflow_dispatch:

jobs:
    compare:
        runs-on: ubuntu-latest

        env:
            TARGET_DIR: target-repo
            HUMAN_IMG: human-image:latest
            DOCKAI_IMG: dockai-image:latest
            CNB_IMG: cnb-image:latest

        steps:
            - name: Checkout orchestrator repo
              uses: actions/checkout@v4

            - name: Read config.json for target repo
              id: cfg
              run: |
                  REPO_URL=$(jq -r '.repository_url' config.json)
                  REPO_PATH=$(echo "$REPO_URL" | sed 's|https://github.com/||' | sed 's|\.git$||')
                  echo "repo_path=$REPO_PATH" >> $GITHUB_OUTPUT
                  echo "REPO_PATH=$REPO_PATH" >> $GITHUB_ENV
                  echo "Target: $REPO_PATH"

            - name: Checkout target repository
              uses: actions/checkout@v4
              with:
                  repository: ${{ steps.cfg.outputs.repo_path }}
                  path: ${{ env.TARGET_DIR }}

            - name: Preserve human Dockerfile if present
              run: |
                  if [ -f "${TARGET_DIR}/Dockerfile" ]; then
                    cp "${TARGET_DIR}/Dockerfile" "${TARGET_DIR}/Dockerfile.human"
                  fi

            - name: Check human Dockerfile presence
              id: human_exists
              run: |
                  if [ -f "${TARGET_DIR}/Dockerfile.human" ]; then
                    echo "present=true" >> $GITHUB_OUTPUT
                  else
                    echo "present=false" >> $GITHUB_OUTPUT
                  fi

            - name: Generate DockAI Dockerfile
              uses: itzzjb/dockai@v3
              with:
                  openai_api_key: ${{ secrets.OPENAI_API_KEY }}
                  project_path: ${{ env.TARGET_DIR }}
                  max_retries: 5
                  model_analyzer: gpt-4o-mini
                  model_blueprint: gpt-4o-mini
                  model_generator: gpt-4o-mini
                  model_generator_iterative: gpt-4o-mini
                  model_reviewer: gpt-4o-mini
                  model_reflector: gpt-4o-mini
                  model_error_analyzer: gpt-4o-mini
                  model_iterative_improver: gpt-4o-mini

            - name: Keep DockAI Dockerfile alongside human
              run: |
                  if [ -f "${TARGET_DIR}/Dockerfile" ]; then
                    mv "${TARGET_DIR}/Dockerfile" "${TARGET_DIR}/Dockerfile.dockai"
                  fi
                  if [ -f "${TARGET_DIR}/Dockerfile.human" ]; then
                    mv "${TARGET_DIR}/Dockerfile.human" "${TARGET_DIR}/Dockerfile"
                  fi

            - name: Hadolint human Dockerfile
              if: ${{ steps.human_exists.outputs.present == 'true' }}
              run: |
                  docker run --rm -i hadolint/hadolint hadolint -f json - < "${TARGET_DIR}/Dockerfile" > hadolint-human.json

            - name: Hadolint DockAI Dockerfile
              run: |
                  docker run --rm -i hadolint/hadolint hadolint -f json - < "${TARGET_DIR}/Dockerfile.dockai" > hadolint-dockai.json

            - name: Build human image (if Dockerfile exists)
              run: |
                  if [ -f "${TARGET_DIR}/Dockerfile" ]; then
                    docker build -t ${HUMAN_IMG} ${TARGET_DIR}
                  else
                    echo "No human Dockerfile; skipping human build"
                  fi

            - name: Build DockAI image
              run: |
                  if [ -f "${TARGET_DIR}/Dockerfile.dockai" ]; then
                    docker build -f ${TARGET_DIR}/Dockerfile.dockai -t ${DOCKAI_IMG} ${TARGET_DIR}
                  else
                    echo "Missing DockAI Dockerfile" && exit 1
                  fi

            - name: Install pack CLI
              run: |
                  set -euo pipefail
                  PACK_VERSION=0.33.2
                  url="https://github.com/buildpacks/pack/releases/download/v${PACK_VERSION}/pack-v${PACK_VERSION}-linux.tgz"
                  curl -sSL "$url" | sudo tar -C /usr/local/bin -xz pack
                  sudo chmod +x /usr/local/bin/pack
                  /usr/local/bin/pack --version

            - name: Install Trivy
              run: |
                  set -euo pipefail
                  sudo apt-get update -qq
                  sudo apt-get install -y wget apt-transport-https gnupg lsb-release
                  wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo gpg --dearmor -o /usr/share/keyrings/trivy.gpg
                  echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
                  sudo apt-get update -qq
                  sudo apt-get install -y trivy

            - name: Build CNB image
              run: |
                  pack build ${CNB_IMG} \
                    --path ${TARGET_DIR} \
                    --builder paketobuildpacks/builder:base \
                    --pull-policy if-not-present

            - name: Run Trivy scan on human image
              if: ${{ steps.human_exists.outputs.present == 'true' }}
              run: |
                  set -euo pipefail
                  trivy image --quiet --format json -o trivy-human.json ${HUMAN_IMG}

            - name: Run Trivy scan on DockAI image
              run: |
                  set -euo pipefail
                  trivy image --quiet --format json -o trivy-dockai.json ${DOCKAI_IMG}

            - name: Run Trivy scan on CNB image
              run: |
                  set -euo pipefail
                  trivy image --quiet --format json -o trivy-cnb.json ${CNB_IMG}

            - name: Collect metrics and compare
              id: metrics
              run: |
                  set -e
                  report=report.md
                  human_from="N/A"; dockai_from="N/A"
                  [ -f "${TARGET_DIR}/Dockerfile" ] && human_from=$(grep -m1 '^FROM ' "${TARGET_DIR}/Dockerfile" | awk '{print $2}')
                  [ -f "${TARGET_DIR}/Dockerfile.dockai" ] && dockai_from=$(grep -m1 '^FROM ' "${TARGET_DIR}/Dockerfile.dockai" | awk '{print $2}')

                  get_size_layers() {
                    img=$1
                    if docker image inspect "$img" >/dev/null 2>&1; then
                      size=$(docker image inspect "$img" --format '{{.Size}}')
                      layers=$(docker history "$img" --no-trunc | tail -n +2 | wc -l)
                    else
                      size=0; layers=0
                    fi
                    echo "$size $layers"
                  }

                  read human_size human_layers < <(get_size_layers ${HUMAN_IMG})
                  read dockai_size dockai_layers < <(get_size_layers ${DOCKAI_IMG})
                  read cnb_size cnb_layers < <(get_size_layers ${CNB_IMG})

                  human_hadolint="N/A"
                  if [ -f hadolint-human.json ]; then
                    human_hadolint=$(jq 'length' hadolint-human.json)
                  fi
                  dockai_hadolint="N/A"
                  if [ -f hadolint-dockai.json ]; then
                    dockai_hadolint=$(jq 'length' hadolint-dockai.json)
                  fi

                  trivy_totals() {
                    file=$1
                    if [ -f "$file" ]; then
                      total=$(jq '[.Results[].Vulnerabilities[]?] | length' "$file")
                      high=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' "$file")
                      echo "$total $high"
                    else
                      echo "N/A N/A"
                    fi
                  }

                  read human_trivy_total human_trivy_high < <(trivy_totals trivy-human.json)
                  read dockai_trivy_total dockai_trivy_high < <(trivy_totals trivy-dockai.json)
                  read cnb_trivy_total cnb_trivy_high < <(trivy_totals trivy-cnb.json)

                  to_num() {
                    val=$1
                    if echo "$val" | grep -Eq '^[0-9]+$'; then
                      echo "$val"
                    else
                      echo 0
                    fi
                  }

                  score() {
                    sz_bytes=$1; layers=$2; hadocnt=$3; trivytotal=$4; trivyhigh=$5
                    python - <<'PY'
                    import os
                    sz_bytes=float(os.environ.get("SZ",0))
                    layers=float(os.environ.get("LAYERS",0))
                    hadocnt=float(os.environ.get("HADO",0))
                    trivyt=float(os.environ.get("TRIVY_T",0))
                    trivyh=float(os.environ.get("TRIVY_H",0))
                    score=max(0, 100 - (sz_bytes/1024/1024)*0.1 - layers*1.5 - hadocnt*0.5 - trivyt*0.25 - trivyh*1.0)
                    print(score)
                    PY
                  }

                  human_score=$(SZ=$human_size LAYERS=$human_layers HADO=$(to_num $human_hadolint) TRIVY_T=$(to_num $human_trivy_total) TRIVY_H=$(to_num $human_trivy_high) score)
                  dockai_score=$(SZ=$dockai_size LAYERS=$dockai_layers HADO=$(to_num $dockai_hadolint) TRIVY_T=$(to_num $dockai_trivy_total) TRIVY_H=$(to_num $dockai_trivy_high) score)
                  cnb_score=$(SZ=$cnb_size LAYERS=$cnb_layers HADO=0 TRIVY_T=$(to_num $cnb_trivy_total) TRIVY_H=$(to_num $cnb_trivy_high) score)

                  printf '%s\n' \
                    '# Container Build Comparison' \
                    '' \
                    '## Inputs' \
                    "- Target repository: ${REPO_PATH}" \
                    '' \
                    '## Dockerfile origins' \
                    "- Human Dockerfile: ${human_from}" \
                    "- DockAI Dockerfile: ${dockai_from}" \
                    '- CNB Buildpacks: paketobuildpacks/builder:base' \
                    '' \
                    '## Image Metrics' \
                    '| Image | Size (bytes) | Layers | Score (lower size & layers = higher) |' \
                    '| --- | --- | --- | --- |' \
                    "| Human | ${human_size} | ${human_layers} | ${human_score} |" \
                    "| DockAI | ${dockai_size} | ${dockai_layers} | ${dockai_score} |" \
                    "| CNB | ${cnb_size} | ${cnb_layers} | ${cnb_score} |" \
                    '' \
                    '## Lint & Vulnerability Summary' \
                    '| Item | Hadolint Findings | Trivy Vulns (total) | Trivy High/Critical |' \
                    '| --- | --- | --- | --- |' \
                    "| Human | ${human_hadolint} | ${human_trivy_total} | ${human_trivy_high} |" \
                    "| DockAI | ${dockai_hadolint} | ${dockai_trivy_total} | ${dockai_trivy_high} |" \
                    "| CNB | N/A | ${cnb_trivy_total} | ${cnb_trivy_high} |" \
                    '' \
                    '## Notes' \
                    '- Scores: 100 - 0.1*sizeMB - 1.5*layers - 0.5*hadolint_count - 0.25*trivy_total - 1.0*trivy_high (floored at 0).' \
                    '- Higher score rewards smaller images, fewer layers, and fewer lint/vuln findings.' \
                    '- Base images extracted from first FROM line.' \
                    > "$report"
                  echo "report_path=$report" >> $GITHUB_OUTPUT

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: comparison-report
                  if-no-files-found: warn
                  path: |
                      report.md
                      ${{ env.TARGET_DIR }}/Dockerfile
                      ${{ env.TARGET_DIR }}/Dockerfile.dockai
                      hadolint-human.json
                      hadolint-dockai.json
                      trivy-human.json
                      trivy-dockai.json
                      trivy-cnb.json
