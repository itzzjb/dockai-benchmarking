name: Compare DockAI vs Human vs CNB (Academic Benchmark)

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: "Override repository URL"
        required: false
        default: ""
      branch:
        description: "Branch or ref to build"
        required: false
        default: ""

jobs:
  compare:
    name: Empirical Evaluation (Size, Time, Security)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      TARGET_DIR: target-repo
      REPORT_PATH: report.md
      HUMAN_IMG: human:compare
      DOCKAI_IMG: dockai:compare
      CNB_IMG: cnb:compare
      PACK_VERSION: 0.36.2

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v6.0.1

      - name: Install dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq bc

      - name: Set up Trivy CLI (0.68.1)
        uses: aquasecurity/setup-trivy@e6c2c5e321ed9123bda567646e2f96565e34abe1
        with:
          version: v0.68.1
          cache: true

      - name: Set up pack CLI
        uses: buildpacks/github-actions/setup-pack@v5.9.7
        with:
          pack-version: ${{ env.PACK_VERSION }}

      - name: Resolve repository and branch
        id: repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          input_repo="${{ github.event.inputs.repo_url }}"
          input_branch="${{ github.event.inputs.branch }}"
          config_repo=$(jq -r '.repository_url // empty' config.json)
          repo_url="${input_repo:-$config_repo}"

          if [ -z "$repo_url" ]; then echo "Repo URL required" >&2; exit 1; fi

          # Simple clone URL construction for brevity in research context
          clone_url="https://github.com/${repo_url}"
          auth_clone_url="$clone_url"
          if [ -n "${GITHUB_TOKEN:-}" ]; then
             auth_clone_url="https://${GITHUB_ACTOR:-github-actions}:${GITHUB_TOKEN}@github.com/${repo_url}"
          fi

          echo "clone_url=$clone_url" >> "$GITHUB_OUTPUT"
          echo "auth_clone_url=$auth_clone_url" >> "$GITHUB_OUTPUT"
          echo "repo_label=$repo_url" >> "$GITHUB_OUTPUT"
          echo "branch=${input_branch:-main}" >> "$GITHUB_OUTPUT"

      - name: Checkout target repo
        run: |
          set -euo pipefail
          rm -rf "${TARGET_DIR}"
          git clone --depth 1 "${{ steps.repo.outputs.auth_clone_url }}" "${TARGET_DIR}"
          # Reset remote to avoid token leak
          git -C "${TARGET_DIR}" remote set-url origin "${{ steps.repo.outputs.clone_url }}"

      - name: Backup human Dockerfile
        run: |
          if [ -f "${TARGET_DIR}/Dockerfile" ]; then
            cp "${TARGET_DIR}/Dockerfile" "${TARGET_DIR}/Dockerfile.human.bak"
          fi

      - name: Generate DockAI Dockerfile
        uses: itzzjb/dockai@v3
        with:
          openai_api_key: ${{ secrets.OPENAI_API_KEY }}
          project_path: ${{ env.TARGET_DIR }}
          max_retries: 5

      - name: Organize Dockerfiles
        run: |
          # Save DockAI file
          if [ -f "${TARGET_DIR}/Dockerfile" ]; then
            mv "${TARGET_DIR}/Dockerfile" "${TARGET_DIR}/Dockerfile.dockai"
          fi
          # Restore Human file
          if [ -f "${TARGET_DIR}/Dockerfile.human.bak" ]; then
            mv "${TARGET_DIR}/Dockerfile.human.bak" "${TARGET_DIR}/Dockerfile"
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.11.1

      - name: Check Artifact Existence
        id: detect
        run: |
          [ -f "${TARGET_DIR}/Dockerfile" ] && echo "human_present=true" >> "$GITHUB_OUTPUT" || echo "human_present=false" >> "$GITHUB_OUTPUT"
          [ -f "${TARGET_DIR}/Dockerfile.dockai" ] && echo "dockai_present=true" >> "$GITHUB_OUTPUT" || echo "dockai_present=false" >> "$GITHUB_OUTPUT"

      # --- BUILD & TIME MEASUREMENT STEPS ---

      - name: Build Human (Measure Time)
        if: steps.detect.outputs.human_present == 'true'
        run: |
          start=$(date +%s)
          docker build --file "${TARGET_DIR}/Dockerfile" --tag "${HUMAN_IMG}" "${TARGET_DIR}"
          end=$(date +%s)
          echo "$((end-start))" > human_time.txt

      - name: Build DockAI (Measure Time)
        if: steps.detect.outputs.dockai_present == 'true'
        run: |
          start=$(date +%s)
          docker build --file "${TARGET_DIR}/Dockerfile.dockai" --tag "${DOCKAI_IMG}" "${TARGET_DIR}"
          end=$(date +%s)
          echo "$((end-start))" > dockai_time.txt

      - name: Build CNB (Measure Time)
        run: |
          start=$(date +%s)
          pack build "${CNB_IMG}" --builder paketobuildpacks/builder:base --path "${TARGET_DIR}" --pull-policy if-not-present
          end=$(date +%s)
          echo "$((end-start))" > cnb_time.txt

      # --- METRIC COLLECTION ---

      - name: Trivy Scans
        run: |
          # Function to run trivy safely
          run_trivy() {
            local img=$1
            local out=$2
            if docker image inspect "$img" >/dev/null 2>&1; then
              trivy image --format json --output "$out" --severity CRITICAL,HIGH,MEDIUM,LOW "$img"
            else
              echo "{}" > "$out"
            fi
          }
          run_trivy "${HUMAN_IMG}" trivy-human.json
          run_trivy "${DOCKAI_IMG}" trivy-dockai.json
          run_trivy "${CNB_IMG}" trivy-cnb.json

      - name: Calculate Academic Metrics (C_total)
        id: math
        env:
          W_SIZE: 0.3
          W_TIME: 0.2
          W_SEC: 0.5
        run: |
          set -e

          # 1. READ RAW METRICS
          get_size() { docker image inspect "$1" --format '{{.Size}}' 2>/dev/null || echo 0; }
          get_time() { cat "$1" 2>/dev/null || echo 0; }

          # Security Index Calculation: (10*Crit + 5*High + 2*Med + 1*Low)
          get_omega() {
            local f=$1
            if [ ! -s "$f" ] || [ "$(cat "$f")" = "{}" ]; then echo 0; return; fi
            jq -r '
              reduce (.Results[].Vulnerabilities[]? // empty) as $v (0; 
                if $v.Severity == "CRITICAL" then . + 10
                elif $v.Severity == "HIGH" then . + 5
                elif $v.Severity == "MEDIUM" then . + 2
                elif $v.Severity == "LOW" then . + 1
                else . end
              )
            ' "$f"
          }

          # Get Raw Values
          h_size=$(get_size "${HUMAN_IMG}"); h_time=$(get_time human_time.txt); h_omega=$(get_omega trivy-human.json)
          d_size=$(get_size "${DOCKAI_IMG}"); d_time=$(get_time dockai_time.txt); d_omega=$(get_omega trivy-dockai.json)
          c_size=$(get_size "${CNB_IMG}");    c_time=$(get_time cnb_time.txt);   c_omega=$(get_omega trivy-cnb.json)

          # Avoid Divide by Zero for Baseline (CNB)
          [ "$c_size" -eq 0 ] && c_size=1
          [ "$c_time" -eq 0 ] && c_time=1
          [ "$c_omega" -eq 0 ] && c_omega=1

          # 2. CALCULATE NORMALIZED METRICS (Baseline = CNB)
          # awk is used for floating point precision
          calc_metrics() {
             awk -v s="$1" -v t="$2" -v w="$3" \
                 -v bs="$4" -v bt="$5" -v bw="$6" \
                 -v ws="$W_SIZE" -v wt="$W_TIME" -v ww="$W_SEC" '
             BEGIN {
               # Normalize (Value / Baseline)
               ns = s / bs
               nt = t / bt
               nw = w / bw
               
               # Composite Cost Function (Lower is Better)
               ctotal = (ws * ns) + (wt * nt) + (ww * nw)
               
               printf "%.4f %.4f %.4f %.4f", ctotal, ns, nt, nw
             }'
          }

          read h_score h_ns h_nt h_nw < <(calc_metrics "$h_size" "$h_time" "$h_omega" "$c_size" "$c_time" "$c_omega")
          read d_score d_ns d_nt d_nw < <(calc_metrics "$d_size" "$d_time" "$d_omega" "$c_size" "$c_time" "$c_omega")
          # CNB Score is always 1.0 by definition
          c_score="1.0000"

          # 3. DETERMINE WINNER (Lowest Score Wins)
          winner="CNB (Baseline)"
          lowest=$c_score

          # Compare Float Strings
          if (( $(echo "$h_score < $lowest" | bc -l) )); then lowest=$h_score; winner="Human"; fi
          if (( $(echo "$d_score < $lowest" | bc -l) )); then lowest=$d_score; winner="DockAI"; fi

          # Export for Report
          echo "winner=$winner" >> "$GITHUB_ENV"

          # Export JSON for the Math Slide
          cat <<EOF > results.json
          {
            "baseline": {"size": $c_size, "time": $c_time, "omega": $c_omega, "cost": 1.0},
            "human": {"size": $h_size, "time": $h_time, "omega": $h_omega, "cost": $h_score},
            "dockai": {"size": $d_size, "time": $d_time, "omega": $d_omega, "cost": $d_score}
          }
          EOF

      - name: Generate Academic Report
        run: |
          # Convert sizes to MB for display
          to_mb() { awk -v v="$1" 'BEGIN {printf "%.2f", v/1024/1024}'; }

          # Read JSON
          hs=$(jq '.human.size' results.json); ht=$(jq '.human.time' results.json); ho=$(jq '.human.omega' results.json); hc=$(jq '.human.cost' results.json)
          ds=$(jq '.dockai.size' results.json); dt=$(jq '.dockai.time' results.json); do=$(jq '.dockai.omega' results.json); dc=$(jq '.dockai.cost' results.json)
          cs=$(jq '.baseline.size' results.json); ct=$(jq '.baseline.time' results.json); co=$(jq '.baseline.omega' results.json)

          cat > "${REPORT_PATH}" <<EOF
          # Empirical Evaluation Report
          **Method:** Composite Optimization Metric ($C_{total}$)
          **Winner:** ${winner}

          ## 1. Executive Summary (Lower $C_{total}$ is Better)
          | Method | Size (MB) | Build Time (s) | Sec. Index ($\Omega$) | **$C_{total}$ Score** |
          | :--- | :--- | :--- | :--- | :--- |
          | **CNB (Baseline)** | $(to_mb $cs) | $ct | $co | **1.0000** |
          | **Human** | $(to_mb $hs) | $ht | $ho | **$hc** |
          | **DockAI (Ours)** | $(to_mb $ds) | $dt | $do | **$dc** |

          ## 2. Mathematical Definition
          The **Composite Optimization Metric ($C_{total}$)** is calculated as:
          $$C_{total} = 0.3 \cdot \hat{S} + 0.2 \cdot \hat{T} + 0.5 \cdot \hat{V}$$

          Where:
          * $\hat{S}, \hat{T}, \hat{V}$ are normalized ratios against the CNB baseline.
          * Security Index ($\Omega$) = $(10 \times Crit) + (5 \times High) + (2 \times Med) + (1 \times Low)$

          ## 3. Raw Data (For Paper)
          \`\`\`json
          $(cat results.json)
          \`\`\`
          EOF

      - name: Upload Research Data
        uses: actions/upload-artifact@v5.0.0
        with:
          name: research-data
          path: |
            report.md
            results.json
            trivy-*.json
            *_time.txt
